@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@using BlogReview.Models
@model Article

@{
    ViewData["Title"] = Localizer["CreateArticlePageTitle"];
}
@{
    var groupNames = ViewData["Groups"] as List<string>;
    bool existing = Model != null && Model.Id != Guid.Empty;
    List<string> tags = new();
    if (existing)
    {
        tags = Model.Tags.Select(t => t.Tag.Name).ToList();
    }
}

<link id="editorStyle" rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    [data-bs-theme="dark"] .select2-selection.select2-selection--multiple {
        background-color: #212529;
        color: gray;
        border: 1px solid #606060;
    }

    [data-bs-theme="dark"] .select2-results {
        background-color: #212529;
        border: 1px solid #606060;
        color: gray;
    }

    [data-bs-theme="dark"] .select2-selection__choice__display {
        color: gray;
    }

    [data-bs-theme="dark"] .select2-search__field {
        color: gray;
        caret-color: gray;
    }

    [data-bs-theme="dark"] .select2-results__option--highlighted {
        background-color: gray !important;
    }

    .select2-container {
        max-width: 800px; 
        margin: 0 auto;
    }

</style>

<div>
    <form onsubmit="return validate()" action='@Url.Action("Article", "Feed")' method="POST" style="max-width: 800px; margin: 0 auto;">
        <input hidden asp-for=Id />
        <div class="form-group">
            <label for="title">@Localizer["ArticleTitle"]</label>
            <input asp-for=Title type="text" class="form-control" id="title" placeholder=@Localizer["ArticleTitle"] required>
        </div>
        <div class="form-group">
            <label for="articleEditor">@Localizer["ArticleContent"]</label>
            <textarea asp-for=Content class="form-control" id="articleEditor" rows="6"></textarea>
            <div class="invalid-feedback">Article content is required</div>
        </div>
        <div class="form-group">
            <label for="rating">@Localizer["ArticleRating"]</label>
            <input asp-for=Rating type="number" class="form-control" id="rating" placeholder=@Localizer["ArticleRating"] min="0" max="10" required>
        </div>
        <div class="form-group">
            <label for="articleObjectName">@Localizer["ArticleObjectName"]</label>
            <input asp-for=ArticleObject.Name type="text" class="form-control" id="articleObjectName" placeholder=@Localizer["ArticleObjectName"] disabled="@existing" required>
        </div>
        <div class="form-group">
            <label for="group">@Localizer["ArticleObjectGroup"]</label>
            <select asp-for="ArticleObject.Group" class="form-control" id="group" disabled="@existing">
                @foreach (var groupName in groupNames)
                {
                    <option value="@groupName">@groupName</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label for="tags">@Localizer["ArticleTags"]</label>
            <input class="form-control" type="text" id="tags" multiple>
        </div>

        <button type="submit" class="btn btn-secondary mt-2">@Localizer["SubmitButton"]</button>
    </form>
</div>
<script>
    $("#tags").select2({
        placeholder: '@Localizer["TagsPlaceholder"]',
        tags: true,
        autocomplete: true,
        language: {
            "searching": function () {
                return '@Localizer["TagsSearching"]';
            },
            "inputTooShort": function (args) {
                return '@Localizer["TagsMinCharacters"]';
            },
        },
        theme: "bootstrap-5",
        minimumInputLength: 1,
        ajax: {
            url: '@Url.Action("AllTags", "Feed")',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    query: params.term
                };
            },
            processResults: function (data) {
                return {
                    results: data
                };
            },
            cache: true
        }
    });
    $('#tags').on('select2:select', function (e) {
        var tag = e.params.data.text;
        $(this).val('').trigger('change');
        $(this).append('<option value="' + tag + '" selected>' + tag + '</option>');
    });
    @foreach (var tag in tags)
    {
        @:$('#tags').append('<option value="' + '@tag' + '" selected>' + '@tag' + '</option>').trigger('change');
    }
    const darkModeStyle = "https://cdn.rawgit.com/CoffeePerry/simplemde-theme-bootstrap-dark/master/dist/simplemde-theme-bootstrap-dark.min.css";
    const lightModeStyle = "https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css";
    var editor = new SimpleMDE({
        element: document.getElementById("articleEditor"), forceSync: true });
    var lightModeButton = document.getElementById('btnSwitch');
    var modeLink = document.getElementById('editorStyle');
    var mode = localStorage.getItem("theme");
    if (mode == 'dark') {
        modeLink.href = darkModeStyle;
    } else {
        modeLink.href = lightModeStyle;
    }
    lightModeButton.addEventListener("click", function () {
        if (mode == 'light') {
            modeLink.href = darkModeStyle;
            mode = "dark";
        } else {
            modeLink.href = lightModeStyle;
            mode = "light";
        }
    })
    function validate() {
        var res = editor.value() !== "" && editor.value() != null;
        var field = document.getElementById("articleEditor");
        if (!res)
        {
            field.classList.add("is-invalid");
        } else {
            field.classList.remove("is-invalid");
        }
        return res;
    }
    document.querySelector('form').addEventListener('submit', function (e) {
        e.preventDefault();
        const params = new URLSearchParams(window.location.search);
        const authorId = params.get('authorId');

        var form = e.target;
        var data = new FormData(form);

        var tags = $('#tags').select2('data');
        var sendTags = [];
        tags.forEach(el => sendTags.push(el.text));
        data.append('tags', sendTags);
        data.append('authorId', authorId);

        fetch(form.action, {
            method: form.method,
            body: data
        }).then(resp => {
            window.location = resp.url; 
        });
    });
</script>